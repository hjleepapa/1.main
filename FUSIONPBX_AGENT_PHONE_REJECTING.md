# Fix Agent Phone Rejecting Calls (SIP 603 Decline)

## üîç About external.xml

**Which component uses `external.xml`?**

The `external.xml` file is used by **FreeSWITCH's Sofia SIP stack** (the `mod_sofia` module). However, since you're using **FusionPBX**, FusionPBX actually:

1. **Stores SIP profile settings in its PostgreSQL database** (table: `v_sip_profile_settings`)
2. **Generates the XML files** (like `external.xml`) from the database when FreeSWITCH reloads
3. **Overwrites manual XML edits** when you click "Reload XML" in FusionPBX GUI

**Therefore:**
- ‚úÖ **Manual edits to `external.xml` may be overwritten** by FusionPBX
- ‚úÖ **Use FusionPBX GUI** to change SIP profile settings (recommended)
- ‚úÖ **Or update the database directly** if GUI doesn't work

**Location:**
- `/etc/freeswitch/sip_profiles/external.xml` - Generated by FusionPBX
- FusionPBX stores settings in: `v_sip_profile_settings` table

**To see current settings:**
```bash
fs_cli -x "sofia xmlstatus profile external"
```

This shows what FreeSWITCH is actually using, regardless of what's in the XML file.

---

## üî¥ Problem: Agent's Phone Explicitly Rejects the Call

**From your logs:**
- ‚úÖ Codec negotiation works (PCMU matched)
- ‚úÖ Call reaches extension 2001
- ‚úÖ Extension rings (Ring-Ready, proceeding[180])
- ‚ùå **Agent's phone sends SIP 603 Decline** ‚Üí `CALL_REJECTED`
- ‚ùå Call drops ~2.6 seconds after ringing

**Key Log Evidence:**
```
2025-11-03 22:34:13.551108 - Ring-Ready sofia/internal/2001@198.27.217.12:55965!
2025-11-03 22:34:13.551108 - Callstate Change DOWN -> RINGING
2025-11-03 22:34:16.191107 - Channel entering state [terminated][603]  ‚Üê SIP 603 = Decline
2025-11-03 22:34:16.191107 - Hangup sofia/internal/2001@198.27.217.12:55965 [CS_CONSUME_MEDIA] [CALL_REJECTED]

# IMPORTANT: Dialplan is setting caller ID to extension itself:
set(caller_id_name=2001)
set(caller_id_number=2001)
```

**Agent's Phone IP:** `198.27.217.12:55965`

## üéØ Most Likely Root Cause: Caller ID Issue

**Your logs show:**
```
set(caller_id_name=2001)
set(caller_id_number=2001)
```

**This means the call is coming FROM extension 2001 TO extension 2001**, which might cause the agent's phone to reject it as a loop or unknown caller.

**Fix:** The FusionPBX dialplan should preserve the original caller ID from Twilio instead of setting it to the extension number.
