<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sambanova Team Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .team-card {
            transition: transform 0.2s;
        }
        .team-card:hover {
            transform: translateY(-5px);
        }
        .todo-item {
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
        }
        .todo-item.high { border-left-color: #dc3545; }
        .todo-item.medium { border-left-color: #ffc107; }
        .todo-item.low { border-left-color: #28a745; }
        .completed { opacity: 0.6; text-decoration: line-through; }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-users"></i> Sambanova Team Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="user-info">Not logged in</span>
                <button class="btn btn-outline-light ms-2" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Login Form -->
        <div id="login-section" class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4><i class="fas fa-sign-in-alt"></i> Login to Team Dashboard</h4>
                        <button class="btn btn-outline-primary btn-sm" onclick="showRegisterModal()">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" value="admin@sambanova.com" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" value="admin123" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>
                        </form>
                        <div class="mt-3">
                            <div class="d-grid gap-2">
                                <a href="/register" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-user-plus"></i> Create New Account
                                </a>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                Demo credentials: admin@sambanova.com / admin123
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard-section" style="display: none;">
            <!-- Team Selection -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-users"></i> Your Teams</h5>
                        </div>
                        <div class="card-body">
                            <select class="form-select" id="team-select">
                                <option value="">Select a team...</option>
                            </select>
                            <button class="btn btn-success mt-2" onclick="showCreateTeamModal()">
                                <i class="fas fa-plus"></i> Create New Team
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-user-plus"></i> Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary me-2" onclick="showCreateTodoModal()">
                                <i class="fas fa-plus"></i> Create Todo
                            </button>
                            <button class="btn btn-success me-2" onclick="showAddMemberModal()">
                                <i class="fas fa-user-plus"></i> Add Member
                            </button>
                            <button class="btn btn-info me-2" onclick="refreshTodos()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Todos -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-tasks"></i> Team Todos</h5>
                        </div>
                        <div class="card-body">
                            <div id="todos-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading todos...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div class="modal fade" id="createTeamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-team-form">
                        <div class="mb-3">
                            <label for="team-name" class="form-label">Team Name</label>
                            <input type="text" class="form-control" id="team-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="team-description" class="form-label">Description</label>
                            <textarea class="form-control" id="team-description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createTeam()">Create Team</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="reg-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="reg-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="reg-username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="reg-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="reg-first-name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="reg-first-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="reg-last-name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="reg-last-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="reg-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="reg-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="reg-confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="reg-confirm-password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="registerUser()">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Team Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Team Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-member-form">
                        <div class="mb-3">
                            <label for="user-search" class="form-label">Search Users</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="user-search" 
                                       placeholder="Search by email, username, or name">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchUsers()">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                        
                        <div id="user-search-results" class="mb-3" style="display: none;">
                            <label class="form-label">Select User</label>
                            <div id="user-results-list"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="member-role" class="form-label">Role</label>
                            <select class="form-select" id="member-role" required>
                                <option value="">Select a role...</option>
                                <option value="member">Member</option>
                                <option value="admin">Admin</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                        
                        <input type="hidden" id="selected-user-id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addTeamMember()">Add Member</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Todo Modal -->
    <div class="modal fade" id="createTodoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Todo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-todo-form">
                        <div class="mb-3">
                            <label for="todo-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="todo-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="todo-description" class="form-label">Description</label>
                            <textarea class="form-control" id="todo-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="todo-priority" class="form-label">Priority</label>
                            <select class="form-select" id="todo-priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="todo-due-date" class="form-label">Due Date</label>
                            <input type="datetime-local" class="form-control" id="todo-due-date">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createTodo()">Create Todo</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;
        let currentTeam = null;
        let accessToken = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedToken = localStorage.getItem('access_token');
            const savedUser = localStorage.getItem('current_user');
            
            if (savedToken && savedUser) {
                accessToken = savedToken;
                currentUser = JSON.parse(savedUser);
                showDashboard();
                loadUserTeams();
            }
        });

        // Login functionality
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    accessToken = data.tokens.access_token;
                    currentUser = data.user;
                    
                    // Save to localStorage
                    localStorage.setItem('access_token', accessToken);
                    localStorage.setItem('current_user', JSON.stringify(currentUser));
                    
                    showDashboard();
                    loadUserTeams();
                } else {
                    alert('Login failed: ' + data.error);
                }
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        });

        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('user-info').textContent = `Welcome, ${currentUser.full_name}`;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('current_user');
            accessToken = null;
            currentUser = null;
            currentTeam = null;
            
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('dashboard-section').style.display = 'none';
        }

        async function loadUserTeams() {
            try {
                const response = await fetch('/api/teams/', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const teamSelect = document.getElementById('team-select');
                    teamSelect.innerHTML = '<option value="">Select a team...</option>';
                    
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = `${team.name} (${team.role})`;
                        teamSelect.appendChild(option);
                    });
                    
                    // Auto-select first team
                    if (data.teams.length > 0) {
                        teamSelect.value = data.teams[0].id;
                        currentTeam = data.teams[0];
                        loadTeamTodos();
                    }
                } else {
                    console.error('Failed to load teams:', data.error);
                }
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }

        document.getElementById('team-select').addEventListener('change', function() {
            const selectedTeamId = this.value;
            if (selectedTeamId) {
                currentTeam = { id: selectedTeamId };
                loadTeamTodos();
            }
        });

        async function loadTeamTodos() {
            if (!currentTeam) return;
            
            try {
                const response = await fetch(`/api/team-todos/?team_id=${currentTeam.id}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayTodos(data.todos);
                } else {
                    console.error('Failed to load todos:', data.error);
                }
            } catch (error) {
                console.error('Error loading todos:', error);
            }
        }

        function displayTodos(todos) {
            const container = document.getElementById('todos-container');
            
            if (todos.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No todos found</div>';
                return;
            }
            
            container.innerHTML = todos.map(todo => `
                <div class="todo-item ${todo.priority} ${todo.completed ? 'completed' : ''}">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">${todo.title}</h6>
                                    <p class="card-text">${todo.description || 'No description'}</p>
                                    <small class="text-muted">
                                        Created by: ${todo.creator ? todo.creator.full_name : 'Unknown'} |
                                        Assigned to: ${todo.assignee ? todo.assignee.full_name : 'Unassigned'} |
                                        Due: ${todo.due_date ? new Date(todo.due_date).toLocaleString() : 'No due date'}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${getPriorityColor(todo.priority)}">${todo.priority}</span>
                                    ${todo.completed ? '<span class="badge bg-success">Completed</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getPriorityColor(priority) {
            switch (priority) {
                case 'high': return 'danger';
                case 'medium': return 'warning';
                case 'low': return 'success';
                default: return 'secondary';
            }
        }

        function showCreateTeamModal() {
            new bootstrap.Modal(document.getElementById('createTeamModal')).show();
        }

        function showCreateTodoModal() {
            new bootstrap.Modal(document.getElementById('createTodoModal')).show();
        }

        async function createTeam() {
            const name = document.getElementById('team-name').value;
            const description = document.getElementById('team-description').value;
            
            if (!name) {
                alert('Team name is required');
                return;
            }
            
            try {
                const response = await fetch('/api/teams/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ name, description })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createTeamModal')).hide();
                    document.getElementById('create-team-form').reset();
                    loadUserTeams();
                    alert('Team created successfully!');
                } else {
                    alert('Failed to create team: ' + data.error);
                }
            } catch (error) {
                alert('Error creating team: ' + error.message);
            }
        }

        async function createTodo() {
            if (!currentTeam) {
                alert('Please select a team first');
                return;
            }
            
            const title = document.getElementById('todo-title').value;
            const description = document.getElementById('todo-description').value;
            const priority = document.getElementById('todo-priority').value;
            const dueDate = document.getElementById('todo-due-date').value;
            
            if (!title) {
                alert('Todo title is required');
                return;
            }
            
            try {
                const response = await fetch('/api/team-todos/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        priority,
                        due_date: dueDate || null,
                        team_id: currentTeam.id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createTodoModal')).hide();
                    document.getElementById('create-todo-form').reset();
                    loadTeamTodos();
                    alert('Todo created successfully!');
                } else {
                    alert('Failed to create todo: ' + data.error);
                }
            } catch (error) {
                alert('Error creating todo: ' + error.message);
            }
        }

        function refreshTodos() {
            loadTeamTodos();
        }

        function showAddMemberModal() {
            new bootstrap.Modal(document.getElementById('addMemberModal')).show();
        }

        async function searchUsers() {
            const query = document.getElementById('user-search').value.trim();
            
            if (query.length < 2) {
                alert('Please enter at least 2 characters to search');
                return;
            }
            
            try {
                const response = await fetch(`/api/teams/search/users?q=${encodeURIComponent(query)}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayUserSearchResults(data.users);
                } else {
                    alert('Search failed: ' + data.error);
                }
            } catch (error) {
                alert('Search error: ' + error.message);
            }
        }

        function displayUserSearchResults(users) {
            const resultsDiv = document.getElementById('user-search-results');
            const resultsList = document.getElementById('user-results-list');
            
            if (users.length === 0) {
                resultsList.innerHTML = '<div class="text-muted">No users found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            resultsList.innerHTML = users.map(user => `
                <div class="card mb-2 cursor-pointer" onclick="selectUser('${user.id}', '${user.full_name}', '${user.email}')">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${user.full_name}</strong><br>
                                <small class="text-muted">${user.email} (@${user.username})</small>
                            </div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
        }

        function selectUser(userId, fullName, email) {
            document.getElementById('selected-user-id').value = userId;
            document.getElementById('user-search').value = `${fullName} (${email})`;
            document.getElementById('user-search-results').style.display = 'none';
        }

        async function addTeamMember() {
            const userId = document.getElementById('selected-user-id').value;
            const role = document.getElementById('member-role').value;
            
            if (!userId) {
                alert('Please search and select a user first');
                return;
            }
            
            if (!role) {
                alert('Please select a role');
                return;
            }
            
            if (!currentTeam) {
                alert('Please select a team first');
                return;
            }
            
            try {
                const response = await fetch(`/api/teams/${currentTeam.id}/members`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        role: role
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
                    document.getElementById('add-member-form').reset();
                    document.getElementById('user-search-results').style.display = 'none';
                    alert('Member added successfully!');
                    
                    // Refresh team data
                    loadUserTeams();
                } else {
                    alert('Failed to add member: ' + data.error);
                }
            } catch (error) {
                alert('Error adding member: ' + error.message);
            }
        }

        function showRegisterModal() {
            new bootstrap.Modal(document.getElementById('registerModal')).show();
        }

        async function registerUser() {
            const email = document.getElementById('reg-email').value;
            const username = document.getElementById('reg-username').value;
            const firstName = document.getElementById('reg-first-name').value;
            const lastName = document.getElementById('reg-last-name').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            
            if (!email || !username || !firstName || !lastName || !password) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        username,
                        first_name: firstName,
                        last_name: lastName,
                        password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
                    document.getElementById('register-form').reset();
                    alert('Account created successfully! Please login with your credentials.');
                } else {
                    alert('Registration failed: ' + data.error);
                }
            } catch (error) {
                alert('Registration error: ' + error.message);
            }
        }
    </script>
</body>
</html>
